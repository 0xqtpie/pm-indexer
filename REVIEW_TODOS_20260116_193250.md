# Review TODOs

## Critical

- [x] Propagate sync errors instead of swallowing per-source failures; surface partial failure status in metrics/admin responses (`src/services/sync/index.ts`).
- [x] Batch price updates to avoid Postgres parameter limits and hard sync failures (`src/services/sync/index.ts`).

## High

- [x] Fix Polymarket status mapping so `archived` markets are treated as `settled` before `closed` (`src/services/ingestion/normalizer.ts`).
- [x] Add Qdrant/DB consistency safeguards (ordering, retries, or compensation) to avoid orphaned vectors on DB failure (`src/services/sync/index.ts`).
- [x] Avoid refreshing Qdrant payloads for every existing market; only refresh when price/status changed (`src/services/sync/index.ts`, `src/services/sync/diff.ts`).

## Medium

- [x] Add rate-limit bucket eviction/LRU to bound memory usage (`src/api/rate-limit.ts`).
- [x] Ensure Qdrant collection exists on search or add startup warmup to avoid 500s before first sync (`src/services/search/qdrant.ts`, `src/api/routes.ts`).
- [x] Deduplicate `sourceId` list before DB lookups to reduce query load (`src/services/sync/index.ts`).
- [x] Tighten CORS defaults for production; avoid `*` when admin endpoints can be called from browsers (`src/config.ts`, `src/api/routes.ts`).

## Architecture

- [x] Move sync state from module globals to durable storage for restart safety (`src/services/sync/index.ts`); implement via `sync_runs` (status, started_at, ended_at, metrics) and read latest in `getSyncStatus`.
- [x] Consider decoupling ingestion/embedding into background workers or a queue for scale and isolation; minimal path is a `jobs` table + worker using `FOR UPDATE SKIP LOCKED`.

## API/UX

- [x] Standardize error response envelope with stable error codes (`src/api/routes.ts`).
- [x] Add field projection/partial responses to reduce payload size (`src/api/routes.ts`); accept `fields` with an allowlist and build Drizzle select projections.
- [x] Provide cursor-first pagination semantics for list/search endpoints (`src/api/routes.ts`); keyset for markets (sort value + id), cursor with query hash for search.

## Performance

- [x] Stream or chunk ingestion to reduce peak memory during full sync (`src/services/sync/index.ts`).
- [x] Reduce write amplification by skipping unchanged price/status updates (`src/services/sync/diff.ts`).

## Features

- [x] Add watchlists + alerts for price moves and closing soon.
- [x] Add price history tracking and trend endpoints.
- [x] Add similar-market recommendations using vector similarity.
- [x] Add category/tag exploration endpoints with facets and trending tags.

## Security

- [x] Add CSRF protections if admin endpoints are browser-accessible (`src/api/routes.ts`).
- [x] Add separate auth and rate-limits for admin endpoints vs public search.
- [x] Add audit logging for admin operations (`src/api/routes.ts`).

## Code Quality

- [x] Replace per-market content update loop with batched update (`src/services/sync/index.ts`).
- [x] Add tests for sync error propagation, Qdrant collection initialization, and rate limiting.
